---
title: "HW3"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


***********************************************************************************
```{r}
library(tidyverse)
library(glmnet)
library(knitr)
library(Lahman)
library(dplyr)
library(class)
library(DMwR)
library(ggplot2)
```

```{r}
load('market_level.R') # market-level data is datam
load('market_airline_level.R') # market airline level data
```

Set the seed to 0 and randomly allocate 1,000 rows of the market-level data to a test
set, to be used only in (7). Use the rest to do the following.

```{r}
set.seed(0)
test_rows<- sample(nrow(datam),1000) #randomly choose 1000 rows in mkt-level data
test<- datam[test_rows,] # this test set contains 1000 rows chosen above
df <- datam[-test_rows,] # this df set contains the rest rows

```

```{r}
AA<- #find out which market does American Airline enter
  datama %>%
  filter(ticket_carrier=="AA") %>%
  select(-price:-market_income)

df_AA<-left_join(df,AA, by=c("origin_airport_id"="origin_airport_id",
                             "dest_airport_id"="dest_airport_id"))

df_AA$AA=1*(df_AA$ticket_carrier=="AA") #create an indicator which equals to 1 if AA is in this mkt
df_AA<-select(df_AA,-ticket_carrier)
df_AA[is.na(df_AA)]<-0 #fill N/A with 0
colnames(df_AA)
test_AA<-left_join(test,AA, by=c("origin_airport_id"="origin_airport_id",
                             "dest_airport_id"="dest_airport_id"))
test_AA$AA = 1*(test_AA$ticket_carrier=="AA")
test_AA[is.na(test_AA)]<-0
```


Estimate a linear probability model, predicting whether American Airlines enters a
market as a function of the number of competitors.
```{r}
df_AA <- df_AA %>% mutate(comp = num_carriers - AA)
test_AA <- test_AA %>% mutate(comp = num_carriers - AA)

linear_m <- lm(AA~comp, df_AA)
summary(linear_m)
```

```{r}
logit_m <- glm(AA ~ comp,family=binomial(link='logit'),data=df_AA)
summary(logit_m)
```

```{r}
logit_m <- glm(AA ~ comp,family=binomial(link='probit'),data=df_AA)
summary(logit_m)
```

```{r}
train <- df_AA %>% select(AA, comp)
# train$AA <- factor(train$AA)
# test_sample <- test_AA %>% select(AA, comp)
# test_sample$AA <- factor(test_sample$AA)
# target <- train%>%select(AA)
# x <- as.vector(t(target))
# x <- factor(x)
# knn_m <- knn(train=train, test=test_sample, cl=x, k=1)
# table(knn_m)
```

```{r}
uni <- sort(unique(train$comp))
for(i in uni){
 temp = train %>% filter(comp == i)
 cat("The conditional probability of entering condition on ", i, " is: ")
 cat(sum(temp$AA)/nrow(temp), "\n")
}

```

```{r}
plot(train$comp, train$AA)
abline(linear_m)
train$logit_p = predict(logit_m, newdata=train, type="response")
lines(logit_m$model, train, col="green4", lwd=1)
```